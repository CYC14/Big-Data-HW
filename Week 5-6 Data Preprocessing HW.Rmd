---
title: "Week 5-6 Data Preprocessing HW"
author: "B12801002 公衛三 張元貞"
date: "2025-10-19"
output:
  html_document: default
  word_document: default
---
### 1. Introduction & Setup

- Briefly describe the purpose of this analysis (NHANES data, 2021–2023).
- Load all required packages and datasets.
- Ensure reproducibility by including all code chunks in order.


This analysis utilizes data from the 2021-2023 National Health and Nutrition Examination Survey (NHANES) to perform a comprehensive data cleaning and exploratory analysis workflow. In the first phase (Week 5), the primary focus was on Body Mass Index (BMI) and Systolic Blood Pressure (SBP). We compared the data distribution and missingness rates of these variables before and after a rigorous outlier cleaning process, visualizing the results using boxplots. The second phase (Week 6) shifted to exploring sociodemographic disparities by analyzing the distribution of BMI across different race/ethnicity and educational attainment groups. Additionally, we conducted a detailed distribution analysis of repeated blood pressure (BP) measurements to examine trial-to-trial variability.


### 2. Week 5 Components (BMI & SBP Cleaning)

Q1. Among adults aged ≥20 years in the 2021–2023 NHANES, observe the association between BMI and mean systolic blood pressure (SBP) and does the association vary between sex ?
Steps for answering the question:


I. Install & load the related packages

```{r W5 I}
# 1) Packages and folders ---------------------------------------------------
pkgs <- c("tidyverse","haven","janitor","stringr","scales","skimr","naniar") # tidyverse: metapackage (including dplyr, tidyr, ggplot2), haven: read SAS/XPT files
to_install <- setdiff(pkgs, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install)
invisible(lapply(pkgs, library, character.only = TRUE))

dir.create("outputs", showWarnings = FALSE) # where plots will be saved
data_dir <- "C:\\Users\\USER\\Desktop\\健康大數據"                      # folder containing .XPT files

getwd()  # check working directory

# 2) Load raw data ----------------------------------------------------------
demo <- read_xpt(file.path(data_dir,"DEMO_L.XPT")) %>% clean_names()  # %>% is one of the most important operators in the tidyverse, it pronounce as“and then”
bpx  <- read_xpt(file.path(data_dir,"BPXO_L.XPT")) %>% clean_names()  # clean_names() from janitor package: make column names consistent (lowercase, no spaces or special characters)
bmx  <- read_xpt(file.path(data_dir,"BMX_L.XPT"))  %>% clean_names()
```


II. Read the raw data files and quick view to the datasets

```{r W5 II}
# quick overviews (on-screen)
skimr::skim(demo); skimr::skim(bpx); skimr::skim(bmx)

gg_miss_var(bpx, show_pct = TRUE) +
  theme_minimal(base_size = 14) +
  labs(title = "Proportion of Missing Values per Variable")
gg_miss_var(bmx, show_pct = TRUE) +
  theme_minimal(base_size = 14) +
  labs(title = "Proportion of Missing Values per Variable")

```

III. Find out the targeted column from datasets for this question and define them

```{r W5 III}
sbp_cols <- names(bpx)[stringr::str_detect(names(bpx), "^bpxo?sy[1-3]$")]  # names() returns the column names of a data frame.(character vector)
dbp_cols <- names(bpx)[stringr::str_detect(names(bpx), "^bpxo?di[1-3]$")]  # str_detect(x, pattern) returns TRUE or FALSE for each element of x, depending on whether it matches the regex pattern.

```

IV. Build the original variables (including checking the coding correctness) and dataset for constructing plots before cleaning

```{r W5 IV}
bmi_raw <- bmx %>%
  transmute(seqn, bmi_raw = bmxbmi)

sbp_raw <- bpx %>%
  transmute(seqn, sbp_raw = rowMeans(select(., all_of(sbp_cols)), na.rm = TRUE))
dbp_raw <- bpx %>%
  transmute(seqn, dbp_raw = rowMeans(select(., all_of(dbp_cols)), na.rm=TRUE))

table(demo$riagendr) # $ means "grab" the column from the data frame

# 清理人口統計數據並創建 sex 因子變數
demo_sex <- demo %>%
  filter(is.na(riagendr) | riagendr %in% c(1, 2)) %>%
  transmute(
    seqn, 
    age = ridageyr,
    sex = factor(riagendr, levels = c(1, 2), labels = c("Male", "Female"))
  )

## 數據整合與最終清理
dat_raw <- demo_sex %>%
  left_join(sbp_raw, by = "seqn") %>%  # 合併 SBP
  left_join(dbp_raw, by = "seqn") %>%  # 合併 DBP
  left_join(bmi_raw, by = "seqn") %>%  # 合併 BMI
  filter(age >= 20) %>% # 限制年齡 >= 20 歲
  mutate(
    # 將 rowMeans 產生的 NaN 轉換為標準 NA
    sbp_raw = ifelse(is.nan(sbp_raw), NA_real_, sbp_raw),
    dbp_raw = ifelse(is.nan(dbp_raw), NA_real_, dbp_raw),
    bmi_raw = ifelse(is.nan(bmi_raw), NA_real_, bmi_raw)
  )
```


V. Draw the raw data boxplots of BMI & mean SBP separately

```{r W5 V}
# ---- sbp boxplot (BEFORE) ----
sbp_before_df <- dat_raw %>% transmute(stage = "Before (raw sbp)", value = sbp_raw)
x_sbp <- sbp_before_df$value
qs_sbp <- quantile(x_sbp, c(.25,.75), na.rm = TRUE)  # na.rm=TRUE to ignore missing values
iqr_sbp <- qs_sbp[2]-qs_sbp[1]
upper_whisker <- min(max(x_sbp, na.rm = TRUE), qs_sbp[2] + 1.5*iqr_sbp)  # upper whisker position, Q3 + 1.5×IQR, capped by max value.
sbp_before_label_y <- upper_whisker + 0.05*iqr_sbp
sbp_before_N <- sum(!is.na(x_sbp))   # count of non-missing values, !is.na() means "not NA"

p_sbp_before <- ggplot(sbp_before_df, aes(stage, value, fill = stage)) +
  geom_boxplot(width = 0.6, outlier.alpha = 0.15, fatten = 1.2) +
  geom_text(data = tibble(stage="Before (raw sbp)", y=sbp_before_label_y, N=sbp_before_N),
            aes(stage, y, label=paste0("n = ", N)), hjust = -1, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = c("Before (raw sbp)" = "#D6E9F8")) +
  labs(title = "sbp (BEFORE): Raw Distribution", x = NULL, y = "sbp") +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.12))) +
  theme_minimal(base_size = 12) + theme(legend.position = "none", panel.grid.minor = element_blank())
ggsave("outputs/q1_box_sbp_before.png", p_sbp_before, bg = "white")
print(p_sbp_before)

# ---- bmi boxplot (BEFORE) ----
bmi_before_df <- dat_raw %>% transmute(stage = "Before (raw BMI)", value = bmi_raw)
x_bmi <- bmi_before_df$value
qs_bmi <- quantile(x_bmi, c(.25,.75), na.rm = TRUE)  # na.rm=TRUE to ignore missing values
iqr_bmi <- qs_bmi[2]-qs_bmi[1]
upper_whisker <- min(max(x_bmi, na.rm = TRUE), qs_bmi[2] + 1.5*iqr_bmi)  # upper whisker position, Q3 + 1.5×IQR, capped by max value.
bmi_before_label_y <- upper_whisker + 0.05*iqr_bmi
bmi_before_N <- sum(!is.na(x_bmi))   # count of non-missing values, !is.na() means "not NA"

p_bmi_before <- ggplot(bmi_before_df, aes(stage, value, fill = stage)) +
  geom_boxplot(width = 0.6, outlier.alpha = 0.15, fatten = 1.2) +
  geom_text(data = tibble(stage="Before (raw BMI)", y=bmi_before_label_y, N=bmi_before_N),
            aes(stage, y, label=paste0("n = ", N)), hjust = -1, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = c("Before (raw BMI)" = "#D6E9F8")) +
  labs(title = "BMI (BEFORE): Raw Distribution", x = NULL, y = "BMI") +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.12))) +
  theme_minimal(base_size = 12) + theme(legend.position = "none", panel.grid.minor = element_blank())
ggsave("outputs/q1_box_bmi_before.png", p_bmi_before, bg = "white")
print(p_bmi_before)

```


VI. Outlier cleaning (Rule = physiologic bounds + IQR fences + MAD z-score)


```{r W5 VI}
sbp_LO <- 70; sbp_HI <- 260
sbp_clean <- sbp_raw %>%
  mutate(
    q1_sbp = quantile(sbp_raw, 0.25, na.rm=TRUE),
    q3_sbp = quantile(sbp_raw, 0.75, na.rm=TRUE),
    iqr_sbp = q3_sbp - q1_sbp,
    lo_iqr_sbp = q1_sbp - 1.5*iqr_sbp,
    hi_iqr_sbp = q3_sbp + 1.5*iqr_sbp,
    med_sbp = median(sbp_raw, na.rm=TRUE),
    madv_sbp = mad(sbp_raw, na.rm=TRUE),
    z = ifelse(madv_sbp > 0, (sbp_raw - med_sbp)/(madv_sbp*1.4826), 0),  # 1.4826 to make it comparable to SD if normal
    flag = (sbp_raw < sbp_LO | sbp_raw > sbp_HI) | (sbp_raw < lo_iqr_sbp | sbp_raw > hi_iqr_sbp) | (abs(z) > 3.5),  # flag outliers
    sbp_raw_clean = ifelse(flag, NA_real_, sbp_raw)
  ) %>% select(seqn, sbp_raw_clean)


   
BMI_LO <- 10; BMI_HI <- 80
bmi_clean <- bmx %>%
  transmute(seqn, bmxbmi) %>%
  mutate(
    q1_bmi = quantile(bmxbmi, 0.25, na.rm=TRUE),
    q3_bmi = quantile(bmxbmi, 0.75, na.rm=TRUE),
    iqr_bmi = q3_bmi - q1_bmi,
    lo_iqr_bmi = q1_bmi - 1.5*iqr_bmi,
    hi_iqr_bmi = q3_bmi + 1.5*iqr_bmi,
    med_bmi = median(bmxbmi, na.rm=TRUE),
    madv_bmi = mad(bmxbmi, na.rm=TRUE),
    z = ifelse(madv_bmi > 0, (bmxbmi - med_bmi)/(madv_bmi*1.4826), 0),  # 1.4826 to make it comparable to SD if normal
    flag = (bmxbmi < BMI_LO | bmxbmi > BMI_HI) | (bmxbmi < lo_iqr_bmi | bmxbmi > hi_iqr_bmi) | (abs(z) > 3.5),  # flag outliers
    bmxbmi_clean = ifelse(flag, NA_real_, bmxbmi)
  ) %>% select(seqn, bmxbmi_clean)
```


VII. Build AFTER cleaning datasets


```{r W5 VII}
dat_clean <- demo_sex %>%
  left_join(sbp_clean, by="seqn") %>%
  left_join(bmi_clean, by="seqn") %>%
  filter(age >= 20) %>%
  mutate(
    sbp_raw_clean = ifelse(is.nan(sbp_raw_clean), NA_real_, sbp_raw_clean),  # normalize NaN to names()
    bmxbmi_clean = ifelse(is.nan(bmxbmi_clean), NA_real_, bmxbmi_clean)  # normalize NaN to NA
  )
```


VIII. Draw the cleaned data boxplots of BMI & mean SBP


```{r W5 VIII}
# ---- SBP boxplot (AFTER) ----
sbp_after_df <- dat_clean %>% transmute(stage = "After (clean sbp)", value = sbp_raw_clean)
x_sbp <- sbp_after_df$value
qs_sbp <- quantile(x_sbp, c(.25,.75), na.rm = TRUE); 
iqr_sbp <- qs_sbp[2]-qs_sbp[1]
upper_whisker_sbp <- min(max(x_sbp, na.rm = TRUE), qs_sbp[2] + 1.5*iqr_sbp)
sbp_after_label_y <- upper_whisker_sbp + 0.05*iqr_sbp
sbp_after_N <- sum(!is.na(x_sbp))

p_sbp_after <- ggplot(sbp_after_df, aes(stage, value, fill = stage)) +
  geom_boxplot(width = 0.6, outlier.alpha = 0.15, fatten = 1.2) +
  geom_text(data = tibble(stage="After (clean sbp)", y=sbp_after_label_y, N=sbp_after_N),
            aes(stage, y, label=paste0("n = ", N)), hjust = -1, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = c("After (clean sbp)" = "#FCE5CD")) +
  labs(title = "sbp (AFTER): Cleaned Distribution", x = NULL, y = "sbp") +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.12))) +
  theme_minimal(base_size = 12) + theme(legend.position = "none", panel.grid.minor = element_blank())
ggsave("outputs/q1_box_sbp_after.png", p_sbp_after, bg = "white")
print(p_sbp_after)


# ---- BMI boxplot (AFTER) ----
bmi_after_df <- dat_clean %>% transmute(stage = "After (clean BMI)", value = bmxbmi_clean)
x_bmi <- bmi_after_df$value
qs_bmi <- quantile(x_bmi, c(.25,.75), na.rm = TRUE); 
iqr_bmi <- qs_bmi[2]-qs_bmi[1]
upper_whisker_bmi <- min(max(x_bmi, na.rm = TRUE), qs_bmi[2] + 1.5*iqr_bmi)
bmi_after_label_y <- upper_whisker_bmi + 0.05*iqr_bmi
bmi_after_N <- sum(!is.na(x_bmi))

p_bmi_after <- ggplot(bmi_after_df, aes(stage, value, fill = stage)) +
  geom_boxplot(width = 0.6, outlier.alpha = 0.15, fatten = 1.2) +
  geom_text(data = tibble(stage="After (clean BMI)", y=bmi_after_label_y, N=bmi_after_N),
            aes(stage, y, label=paste0("n = ", N)), hjust = -1, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = c("After (clean BMI)" = "#FCE5CD")) +
  labs(title = "BMI (AFTER): Cleaned Distribution", x = NULL, y = "BMI") +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.12))) +
  theme_minimal(base_size = 12) + theme(legend.position = "none", panel.grid.minor = element_blank())
ggsave("outputs/q1_box_bmi_after.png", p_bmi_after, bg = "white")
print(p_bmi_after)
```

IX. Check the NA count change before and after cleaning (by bar plots)

```{r W5 IX}
miss_before_bmi <- tibble(
  stage     = "Before",
  variable  = "BMI",
  n_missing = sum(is.na(dat_raw$bmi_raw)),
  n_total   = nrow(dat_raw)
) %>% mutate(p_missing = n_missing / n_total)

miss_after_bmi <- tibble(
  stage     = "After",
  variable  = "BMI",
  n_missing = sum(is.na(dat_clean$bmxbmi_clean)),
  n_total   = nrow(dat_clean)
) %>% mutate(p_missing = n_missing / n_total)

miss_long_bmi <- bind_rows(miss_before_bmi, miss_after_bmi) %>%
  mutate(stage = factor(stage, levels = c("Before","After")),  # ensure order in plot legend
         variable = factor(variable, levels = "BMI"))          # ensure order in x-axis

p_na_bar_1 <- ggplot(miss_long_bmi, aes(variable, p_missing, fill = stage)) +
  geom_col(width=0.6, position="dodge") +                                                  # dodge to separate bars
  geom_text(aes(label = paste0(scales::percent(p_missing, 0.1),
                               "\n(", n_missing, "/", n_total, ")")),                      # label on top of bars
            vjust=-0.2, size=3.5) +
  scale_y_continuous(labels=scales::percent) +
  labs(title = "SBP Missingness Before vs After Cleaning", x=NULL, y="Missing rate") +
  theme_minimal(base_size=12) + theme(legend.position="top")

pos <- position_dodge(width = 0.65) # to align text labels with bars when using dodge

p_na_bar_2 <- ggplot(miss_long_bmi, aes(variable, p_missing, fill = stage)) +
  geom_col(width = 0.6, position = pos) +
  geom_text(aes(label = paste0(scales::percent(p_missing, 0.1),
                               "\n(", n_missing, "/", n_total, ")")),
            position = pos, vjust = -0.2, size = 3.5, lineheight = 0.95) +
  scale_y_continuous(labels = scales::percent, expand = expansion(mult = c(0, 0.12))) +
  scale_fill_manual(values = c("Before" = "#9EC5FE", "After" = "#FFCF99")) +
  labs(title = "Missingness (NA) Before vs After Outlier Removal (BMI)",
       x = NULL, y = "Missing rate", fill = "Stage") +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"),
        legend.position = "top")

ggsave("outputs/q1_na_bmi_before_after.png", p_na_bar_2, bg = "white")
print(p_na_bar_2)


miss_before_sbp <- tibble(
  stage     = "Before",
  variable  = "SBP",
  n_missing = sum(is.na(dat_raw$sbp_raw)),
  n_total   = nrow(dat_raw)
) %>% mutate(p_missing = n_missing / n_total)

miss_after_sbp <- tibble(
  stage     = "After",
  variable  = "SBP",
  n_missing = sum(is.na(dat_clean$sbp_raw_clean)),
  n_total   = nrow(dat_clean)
) %>% mutate(p_missing = n_missing / n_total)

miss_long_sbp <- bind_rows(miss_before_sbp, miss_after_sbp) %>%
  mutate(stage = factor(stage, levels = c("Before", "After")),
         variable = factor(variable, levels = "SBP")) 

pos <- position_dodge(width = 0.65)
p_na_bar_sbp <- ggplot(miss_long_sbp, aes(variable, p_missing, fill = stage)) +
  geom_col(width = 0.6, position = pos) +
  geom_text(aes(label = paste0(scales::percent(p_missing, 0.1),
                               "\n(", n_missing, "/", n_total, ")")),
            position = pos, vjust = -0.2, size = 3.5, lineheight = 0.95) +
  scale_y_continuous(labels = scales::percent, expand = expansion(mult = c(0, 0.12))) +
  scale_fill_manual(values = c("Before" = "#D6E9F8", "After" = "#B4C6E7")) + 
  labs(title = "Missingness (NA) Before vs After Outlier Removal (SBP)",
       x = NULL, y = "Missing Rate", fill = "Stage") + 
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold"),
        legend.position = "top")

ggsave("outputs/q1_na_sbp_before_after.png", p_na_bar_sbp, bg = "white")
print(p_na_bar_sbp)
```

X. Scatter plot of cleaned BMI vs cleaned SBP by sex

```{r W5 X}
p_scatter_bmi_sbp <- ggplot(dat_clean, aes(x = bmxbmi_clean, y = sbp_raw_clean, color = sex)) +
  
  # 1. 繪製散點圖 (geom_point)，設置 alpha 讓點重疊時能看出密度
  geom_point(alpha = 0.3, size = 1.5) +
  
  # 2. 添加性別分組的平滑/趨勢線 (geom_smooth)
  #    method="lm" 表示使用線性模型 (Linear Model) 來擬合趨勢
  geom_smooth(method = "lm", se = TRUE, linewidth = 1.2) +
  
  # 3. 設置圖表標籤和標題
  labs(
    title = "Association between Cleaned BMI and SBP by Sex",
    x = "Body Mass Index (BMI)",
    y = "Mean Systolic Blood Pressure (SBP, mmHg)",
    color = "Sex" # 圖例標題
  ) +
  
  scale_color_manual(values = c("Male" = "#0072B2", "Female" = "#D55E00")) + # 使用顏色友好的配色
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5), # 標題置中
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

ggsave("outputs/q1_scatter_bmi_sbp_by_sex.png", p_scatter_bmi_sbp, bg = "white")
print(p_scatter_bmi_sbp)
```

The scatter plot clearly reveals a significant positive association between BMI and mean SBP (Systolic Blood Pressure). This indicates that as a subject's BMI increases, their mean SBP also tends to rise.

Overall Trend: Both trend lines exhibit an upward slope, confirming the positive correlation between BMI and mean SBP regardless of sex.

Sex Differences: Although both trend lines show a positive correlation, the SBP trend line for males (blue) generally lies above the SBP trend line for females (red) across most BMI ranges. This suggests that, at the same BMI level, males tend to have a higher SBP.


### 3. Week 6 Components (EDU, Race, and BP Trials)

Q1. Among all the subjects in 2021-2023 NHANES dataset, observe the distribution of BMI in different races and education levels

I. What is the distribution of educational attainment (EDU) and ethnicity (Race) in your data?

```{r W6 Q1 I}
# 1) Check the original coding distribution
demo %>% count(dmdeduc2)
demo %>% count(ridreth3)


# 2) Recode & relabel
dat_edu <- demo %>%
  transmute(
    seqn,
    age = ridageyr,
    EDU = case_when(                  # case_when() is like ifelse() but for multiple conditions
      dmdeduc2 %in% 1:5 ~ dmdeduc2,   # retain 1–5
      TRUE ~ NA_real_                 # 7/9 -> NA
    )
  ) %>%
  mutate(
    EDU = factor(EDU,                 # mutate() adds new variables or transforms existing ones
                 levels = 1:5,
                 labels = c("<9th grade", "9–11th grade", "High school/GED", 
                            "Some college/AA", "College or above"))
  ) %>%
  left_join(dat_clean %>% select(seqn, bmxbmi_clean), by = "seqn") %>%
  drop_na(EDU, bmxbmi_clean)



dat_race <- demo %>%
  transmute(
    seqn,
    age = ridageyr,
    race = case_when(
      ridreth3 %in% 1:7 ~ ridreth3, # 保留 1–7 的有效編碼 (包括跳過的 5)
      TRUE ~ NA_real_              # 將其他編碼 (如缺失值 9) 設為 NA
    )
  ) %>%
  mutate(
    race = factor(race,
                  levels = 1:7,
                  labels = c("Mexican American", 
                             "Other Hispanic", 
                             "Non-Hispanic White", 
                             "Non-Hispanic Black", 
                             "UNUSED",                          # <<< 此處是編碼 5 的位置 ( unused )
                             "Non-Hispanic Asian", 
                             "Other Race / Multi-Racial"
                             )
                  )
  ) %>%
  left_join(dat_clean %>% select(seqn, bmxbmi_clean), by = "seqn") %>%
  drop_na(race, bmxbmi_clean)

  

# 3) distribution table
edu_dist <- dat_edu %>%
  count(EDU) %>%                 # count occurrences of each education level
  mutate(prop = n / sum(n),      # calculate proportions
         variable = "EDU") %>%   # add a variable column for clarity
  rename(category = EDU)         # rename EDU to category for consistency

race_dist <- dat_race %>%
  count(race) %>%                 # count occurrences of each education level
  mutate(prop = n / sum(n),      # calculate proportions
         variable = "race") %>%   # add a variable column for clarity
  rename(category = race)         # rename race to category for consistency


# 4) output table & csv
write.csv(edu_dist, file = "outputs/EDU_distribution.csv", row.names = FALSE) #row.names=FALSE to avoid writing row numbers
write.csv(race_dist, file = "outputs/race_distribution.csv", row.names = FALSE) #row.names=FALSE to avoid writing row numbers


library(knitr)
kable(edu_dist, digits = 3, caption = "Distribution of Educational Attainment (EDU)")
kable(race_dist, digits = 3, caption = "Distribution of race Attainment")

```



II. Please use boxplots to visualize the BMI distribution in different races and education levels.

```{r W6 Q1 II}
p_bmi <- dat_edu %>%
  ggplot(aes(x = EDU, y = bmxbmi_clean)) +                               # aes() defines the aesthetic mapping: x-axis is EDU, y-axis is cleaned BMI
  geom_boxplot(position = position_dodge(0.8), outlier.alpha = 0.2) +    # position_dodge(0.8) separates boxplots for clarity; outlier.alpha adjusts outlier visibility
  labs(title = "BMI across Education Groups",
       x = "Education Level", y = "BMI") +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
ggsave("outputs/BMI_by_EDU_1.png", p_bmi, width = 10, height = 6, bg = "white")


p_race <- dat_race %>%
  ggplot(aes(x = race, y = bmxbmi_clean)) +                               # aes() defines the aesthetic mapping: x-axis is race, y-axis is cleaned BMI
  geom_boxplot(position = position_dodge(0.8), outlier.alpha = 0.2) +    # position_dodge(0.8) separates boxplots for clarity; outlier.alpha adjusts outlier visibility
  labs(title = "BMI across race Groups",
       x = "race", y = "BMI") +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
ggsave("outputs/BMI_by_race_1.png", p_race, width = 10, height = 6, bg = "white")
```

III. Please state your brief conclusion about the plots (Do not need the statistical testsyou’re
your inference).

Educational Attainment (EDU)：
The boxplots show a very wide distribution (large spread) of BMI values within almost all educational attainment groups. While the medians of most groups are quite similar, the College or above group's BMI median is noticeably, albeit slightly, lower than the others. However, a clear, overall correlation between educational attainment and the median BMI is not apparent in this visualization.

Race(race)：
The BMI distributions are extremely wide for all race groups except for the Non-Hispanic Asian group. The median BMI for Non-Hispanic Asian individuals ($\text{<25}$) is distinctly lower than all other groups. The medians for the remaining groups are closely clustered, typically around 30. Similar to the education findings, a clear overall correlation between race/ethnicity and the median BMI among these higher-median groups is not strongly evident.


Q2. Among all the subjects in 2021-2023 NHANES dataset, BPX is the data including three times of examination of blood pressure (SBP & DBP). The values were recorded in different columns (bpxosy1-3; bpxodi1-3) (Reminder: please use the “cleaned” BP data).

I. Currently the dataset is stored in a wide format, meaning that each measurement is placed in a separate column. Please reshape the dataset into a long format, so that each row represents a single measurement, and include the following variables:

(a) seqn: Participant ID
(b) measure (new defined): Measurement type (SBP or DBP)
(c) trial (new defined): Trial number (1, 2, or 3)
(d) value (from each BP value): The recorded blood pressure value

```{r W6 Q2 I}
bpx_long_clean <- bpx %>%
  select(seqn, all_of(c(sbp_cols, dbp_cols))) %>%  
  # From the dataset bpx, you’re selecting: seqn: the participant ID. sbp_cols and dbp_cols: two vectors containing SBP and DBP measurement variable names
  # all_of() ensures all the columns listed in those vectors exist — otherwise R will throw an error
  pivot_longer(
    cols = -seqn, #take every column except seqn and pivot them.
    names_to = c("measure", "trial"), # Split the original column names into two new variables
    names_pattern = "^bpxo([sd]i|sy)([1-3])$",
    # This regular expression defines how column names are split:
    # ^bpxo means names start with “bpxo”.
    # ([sd]i|sy) captures the part indicating pressure type: “di” → diastolic; “sy” → systolic
    # ([1-3]) captures the measurement number (1, 2, or 3).
    # $ means “end of the string.”
    values_to = "value" # The actual blood pressure readings will be stored in a new column named value.
  ) %>%
  mutate(
    measure = recode(measure,
                     "sy" = "SBP",
                     "di" = "DBP"),
    trial = as.integer(trial)
  )
```


II. After reshaping the dataset, create a boxplot to compare the distribution of SBP and DBP across the three trials and facet by the measurement type.

```{r W6 Q2 II}
ggplot(bpx_long_clean, aes(x = factor(trial), y = value, fill = measure)) +
  geom_boxplot(outlier.alpha = 0.2) +
  facet_wrap(~ measure, scales = "free_y") +
  labs(title = "Distribution of SBP & DBP across 3 Trials (Cleaned Data)",
       x = "Trial", y = "Blood Pressure (mmHg)") +
  theme_minimal(base_size = 13)
```

III. Now, suppose we are only interested in the two trials that show the largest difference for each subject. Please complete the tasks aboved.

```{r W6 Q2 III}
# 1) 找出每個受試者/測量類型中，最大值和最小值所在的試驗 (即差異最大的兩次)
bpx_two_trials_only <- bpx_long_clean %>%
  # 按 seqn (受試者) 和 measure (SBP/DBP) 分組
  group_by(seqn, measure) %>%
  # 找出最大值和最小值的血壓值
  mutate(
    max_value = max(value, na.rm = TRUE),
    min_value = min(value, na.rm = TRUE)
  ) %>%
  filter(value == max_value | value == min_value) %>%
  distinct(value, .keep_all = TRUE) %>%
  slice(1:2) %>%
  select(-max_value, -min_value) %>%
  ungroup()

# 2) 重新繪製 Boxplot
p_two_trials <- ggplot(bpx_two_trials_only, aes(x = factor(trial), y = value, fill = measure)) +
  geom_boxplot(outlier.alpha = 0.2) +
  facet_wrap(~ measure, scales = "free_y") +
  labs(
    title = "Distribution of SBP & DBP for Two Trials with Largest Difference",
    subtitle = "For each subject, only the max and min BP value trials are kept.",
    x = "Trial (Original Trial Number)", y = "Blood Pressure (mmHg)"
  ) +
  theme_minimal(base_size = 13)

# 3) 儲存圖表
ggsave("outputs/BMI_by_BPX_Largest_Diff_Two_Trials.png", p_two_trials, width = 10, height = 6, bg = "white")
print(p_two_trials)
```

IV. Please infer whether these blood pressure values were measured at long intervals or on the same day to avoid errors.

The blood pressure values were most likely measured consecutively on the same day to minimize error. In both the SBP and DBP, the median for Trial 1 is slightly higher than the medians for Trial 2 and Trial 3. The median values drop slightly from Trial 1 to Trial 2, and then remain consistent in Trial 3.

This pattern is characteristic of the "white-coat" effect or the habituation phenomenon, where a person's first reading is elevated due to anxiety or a lack of habituation to the measurement process. Subsequent readings (Trial 2 and Trial 3) are typically lower and more representative of the person's true resting blood pressure. This short-interval, repeated measurement method is a standard clinical practice to improve measurement accuracy.


### 4. Conclusion

**BMI and SBP Association:**


A significant positive correlation exists between BMI and mean SBP. Furthermore, this association varies by sex: the SBP trend line for males is generally higher than that for females across the BMI range.


**Sociodemographic Disparities:**


Race shows the most pronounced BMI difference, with Non-Hispanic Asian individuals having a distinctly lower median BMI (<25) compared to other groups, whose medians cluster around 30.

Educational Attainment showed a less distinct pattern, though the College or above group did exhibit a slightly lower median BMI compared to other levels.


**Blood Pressure Measurement: **


The distribution of repeated blood pressure trials (Trial 1 > Trial 2 ≈ Trial 3) strongly suggests that measurements were taken consecutively on the same day at short intervals. This methodology is essential for minimizing the white-coat effect and ensuring the accuracy of the final reported blood pressure value.


**Learned about Reproducible Workflows**


1. Transparency: Every step—from outlier removal (using combined physiologic, IQR, and MAD rules) to data reshaping (pivot_longer)—is explicitly coded, making the entire analytical process auditable and verifiable.


2. Efficiency: The pipe operator (%>%) allowed for the construction of clean, sequential, and highly readable code chunks, which is crucial for managing and updating complex scripts based on large survey datasets like NHANES.


3. Data Integrity: Defining and executing a multi-layered cleaning process ensured that the final conclusions were based on high-quality data, minimizing bias introduced by extreme outliers.




https://github.com/CYC14/Big-Data-HW.git